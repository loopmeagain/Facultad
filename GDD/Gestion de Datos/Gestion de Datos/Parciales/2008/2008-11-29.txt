SELECT
	PROD_CODIGO, PROD_DETALLE, SUM(RCBT_CANTIDAD)
FROM CCBTE, RCBTE , PRODUCTOS
	WHERE 
		CCBT_CODIGO = RCBT_CODIGO     AND 
		CCBT_TIPO   = RCBT_TIPO       AND
		CCBT_SUCURSAL = RCBT_SUCURSAL AND 
		CCBT_CBTE     = RCBT_CBTE     AND
		CCBT_VENDEDOR IN (
				SELECT TOP 2 COMI_VENDEDOR FROM COMISION 
					WHERE YEAR(COMI_FECHA) = YEAR(GETDATE())
				GROUP BY COMI_VENDEDOR ORDER BY SUM(COMI_IMP_COMP) DESC						
				 ) AND -- BUSCA LOS 2 VENDEDORES CON MAYOR COMISION
		RCBT_PRODUCTO = PROD_CODIGO AND
		PROD_CODIGO IN (SELECT COMP_PRODUCTO FROM COMPOSICION) -- TOMA LOS PRODUCTOS CON COMPOSICION
GROUP BY PROD_CODIGO, PROD_DETALLE
HAVING COUNT(DISTINCT CCBT_CODIGO+ CCBT_TIPO +CCBT_SUCURSAL+CCBT_CBTE) >= 5 -- CONSIDERA QUE ESTEN EN 5 FACTURAS O MAS LOS PRODUCTOS
ORDER BY 3 DESC 
		
