CREATE PROCEDURE SP_PARCIAL2
AS
BEGIN
DECLARE @prod CHAR(8)
DECLARE @detalle CHAR(50)
DECLARE @cant_2007 DECIMAL(12,2)
DECLARE @vend_2008 CHAR(50)
DECLARE @es_composicion CHAR(2)
DECLARE @posicion INTEGER 
DECLARE @prom	  DECIMAL(12,2)

	DECLARE PROD_CURS CURSOR FOR
		SELECT 
			PROD_CODIGO, 
			PROD_DETALLE , 
			(SELECT SUM(RCBT_CANTIDAD) FROM RCBTE, CCBTE WHERE 
				RCBT_PRODUCTO = PROD_CODIGO AND 
				RCBT_CODIGO = CCBT_CODIGO AND 
				RCBT_TIPO   = CCBT_TIPO   AND 
				RCBT_SUCURSAL = CCBT_SUCURSAL AND 
				RCBT_CBTE     = CCBT_CBTE  AND 
				YEAR(CCBT_FECHA) = 2007),
			AVG(RCBT_PR_UNIT),
			CASE WHEN (SELECT COUNT(*) FROM COMPOSICION WHERE COMP_PRODUCTO = PROD_CODIGO) <> 0 THEN 'SI' 
				ELSE 'NO'
			END,
			(SELECT TOP 1 VEND_DETALLE FROM VENDEDORES, CCBTE, RCBTE WHERE 
				RCBT_PRODUCTO = PROD_CODIGO AND 
				RCBT_CODIGO = CCBT_CODIGO AND 
				RCBT_TIPO   = CCBT_TIPO   AND 
				RCBT_SUCURSAL = CCBT_SUCURSAL AND 
				RCBT_CBTE     = CCBT_CBTE  AND 
				YEAR(CCBT_FECHA) = 2008 AND 
				CCBT_VENDEDOR = VEND_CODIGO
			  GROUP BY VEND_CODIGO, VEND_DETALLE 
				ORDER BY SUM(RCBT_CANTIDAD) DESC
			)
		FROM PRODUCTOS, RCBTE WHERE PROD_CODIGO = RCBT_PRODUCTO
		GROUP BY PROD_CODIGO, PROD_DETALLE
		ORDER BY SUM(RCBT_CANTIDAD) DESC

	OPEN PROD_CURS
	FETCH NEXT FROM PROD_CURS INTO 
		@prod, @detalle , @cant_2007, @prom, @es_composicion, @vend_2008

	SELECT @posicion = 0
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		SELECT @posicion = @posicion + 1
		INSERT INTO TABLA_RANKING(posicion, cod_prod, nom_prod, cantidad, pre_prod, combo, nom_vend)
			VALUES(@posicion, @prod, @detalle, @cant_2007, @prom, @es_composicion, @vend_2008)

		
		FETCH NEXT FROM PROD_CURS INTO 
				@prod, @detalle , @cant_2007, @prom, @es_composicion, @vend_2008
	END
	CLOSE 	   PROD_CURS
	DEALLOCATE PROD_CURS
		
END		
		
	